***REMOVED***% load l10n %***REMOVED***
OpenLayers.Projection.addTransform("EPSG:4326", "EPSG:3857", OpenLayers.Layer.SphericalMercator.projectForward);
***REMOVED***% block vars %***REMOVED***var ***REMOVED******REMOVED*** module ***REMOVED******REMOVED*** = ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map = null; ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls = null; ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.panel = null; ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.re = new RegExp("^SRID=\\d+;(.+)", "i"); ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers = ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modifiable = ***REMOVED******REMOVED*** modifiable|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.wkt_f = new OpenLayers.Format.WKT();
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_collection = ***REMOVED******REMOVED*** is_collection|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.collection_type = '***REMOVED******REMOVED*** collection_type ***REMOVED******REMOVED***';
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_generic = ***REMOVED******REMOVED*** is_generic|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_linestring = ***REMOVED******REMOVED*** is_linestring|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_polygon = ***REMOVED******REMOVED*** is_polygon|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_point = ***REMOVED******REMOVED*** is_point|yesno:"true,false" ***REMOVED******REMOVED***;
***REMOVED***% endblock %***REMOVED***
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.get_ewkt = function(feat)***REMOVED***
    return 'SRID=***REMOVED******REMOVED*** srid|unlocalize ***REMOVED******REMOVED***;' + ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.wkt_f.write(feat);
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.read_wkt = function(wkt)***REMOVED***
    // OpenLayers cannot handle EWKT -- we make sure to strip it out.
    // EWKT is only exposed to OL if there's a validation error in the admin.
    var match = ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.re.exec(wkt);
    if (match)***REMOVED***wkt = match[1];***REMOVED***
    return ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.wkt_f.read(wkt);
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt = function(feat)***REMOVED***
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_collection)***REMOVED*** ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.num_geom = feat.geometry.components.length;***REMOVED***
    else ***REMOVED*** ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.num_geom = 1;***REMOVED***
    document.getElementById('***REMOVED******REMOVED*** id ***REMOVED******REMOVED***').value = ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.get_ewkt(feat);
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.add_wkt = function(event)***REMOVED***
    // This function will sync the contents of the `vector` layer with the
    // WKT in the text field.
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_collection)***REMOVED***
        var feat = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.***REMOVED******REMOVED*** geom_type ***REMOVED******REMOVED***());
        for (var i = 0; i < ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features.length; i++)***REMOVED***
            feat.geometry.addComponents([***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features[i].geometry]);
        ***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt(feat);
    ***REMOVED*** else ***REMOVED***
        // Make sure to remove any previously added features.
        if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features.length > 1)***REMOVED***
            old_feats = [***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features[0]];
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.removeFeatures(old_feats);
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.destroyFeatures(old_feats);
        ***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt(event.feature);
    ***REMOVED***
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modify_wkt = function(event)***REMOVED***
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_collection)***REMOVED***
        if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_point)***REMOVED***
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.add_wkt(event);
            return;
        ***REMOVED*** else ***REMOVED***
            // When modifying the selected components are added to the
            // vector layer so we only increment to the `num_geom` value.
            var feat = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.***REMOVED******REMOVED*** geom_type ***REMOVED******REMOVED***());
            for (var i = 0; i < ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.num_geom; i++)***REMOVED***
                feat.geometry.addComponents([***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features[i].geometry]);
            ***REMOVED***
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt(feat);
        ***REMOVED***
    ***REMOVED*** else ***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt(event.feature);
    ***REMOVED***
***REMOVED***;
// Function to clear vector features and purge wkt from div
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.deleteFeatures = function()***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.removeFeatures(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.features);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.destroyFeatures();
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.clearFeatures = function ()***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.deleteFeatures();
    document.getElementById('***REMOVED******REMOVED*** id ***REMOVED******REMOVED***').value = '';
    ***REMOVED***% localize off %***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.setCenter(new OpenLayers.LonLat(***REMOVED******REMOVED*** default_lon ***REMOVED******REMOVED***, ***REMOVED******REMOVED*** default_lat ***REMOVED******REMOVED***), ***REMOVED******REMOVED*** default_zoom ***REMOVED******REMOVED***);
    ***REMOVED***% endlocalize %***REMOVED***
***REMOVED***;
// Add Select control
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.addSelectControl = function()***REMOVED***
    var select = new OpenLayers.Control.SelectFeature(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector, ***REMOVED***'toggle' : true, 'clickout' : true***REMOVED***);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addControl(select);
    select.activate();
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.enableDrawing = function()***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.getControlsByClass('OpenLayers.Control.DrawFeature')[0].activate();
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.enableEditing = function()***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.getControlsByClass('OpenLayers.Control.ModifyFeature')[0].activate();
***REMOVED***;
// Create an array of controls based on geometry type
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.getControls = function(lyr)***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.panel = new OpenLayers.Control.Panel(***REMOVED***'displayClass': 'olControlEditingToolbar'***REMOVED***);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls = [new OpenLayers.Control.Navigation()];
    if (!***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modifiable && lyr.features.length) return;
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_linestring || ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_generic)***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls.push(new OpenLayers.Control.DrawFeature(lyr, OpenLayers.Handler.Path, ***REMOVED***'displayClass': 'olControlDrawFeaturePath'***REMOVED***));
    ***REMOVED***
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_polygon || ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_generic)***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls.push(new OpenLayers.Control.DrawFeature(lyr, OpenLayers.Handler.Polygon, ***REMOVED***'displayClass': 'olControlDrawFeaturePolygon'***REMOVED***));
    ***REMOVED***
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_point || ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_generic)***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls.push(new OpenLayers.Control.DrawFeature(lyr, OpenLayers.Handler.Point, ***REMOVED***'displayClass': 'olControlDrawFeaturePoint'***REMOVED***));
    ***REMOVED***
    if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modifiable)***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls.push(new OpenLayers.Control.ModifyFeature(lyr, ***REMOVED***'displayClass': 'olControlModifyFeature'***REMOVED***));
    ***REMOVED***
***REMOVED***;
***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.init = function()***REMOVED***
    ***REMOVED***% block map_options %***REMOVED***// The options hash, w/ zoom, resolution, and projection settings.
    var options = ***REMOVED***
***REMOVED***% autoescape off %***REMOVED******REMOVED***% for item in map_options.items %***REMOVED***      '***REMOVED******REMOVED*** item.0 ***REMOVED******REMOVED***' : ***REMOVED******REMOVED*** item.1 ***REMOVED******REMOVED******REMOVED***% if not forloop.last %***REMOVED***,***REMOVED***% endif %***REMOVED***
***REMOVED***% endfor %***REMOVED******REMOVED***% endautoescape %***REMOVED***    ***REMOVED***;***REMOVED***% endblock %***REMOVED***
    // The admin map for this geometry field.
    ***REMOVED***% block map_creation %***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map = new OpenLayers.Map('***REMOVED******REMOVED*** id ***REMOVED******REMOVED***_map', options);
    // Base Layer
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.base = ***REMOVED***% block base_layer %***REMOVED***new OpenLayers.Layer.WMS("***REMOVED******REMOVED*** wms_name ***REMOVED******REMOVED***", "***REMOVED******REMOVED*** wms_url ***REMOVED******REMOVED***", ***REMOVED***layers: '***REMOVED******REMOVED*** wms_layer ***REMOVED******REMOVED***'***REMOVED******REMOVED*** wms_options|safe ***REMOVED******REMOVED******REMOVED***);***REMOVED***% endblock %***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addLayer(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.base);
    ***REMOVED***% endblock %***REMOVED***
    ***REMOVED***% block extra_layers %***REMOVED******REMOVED***% endblock %***REMOVED***
    ***REMOVED***% if is_linestring %***REMOVED***OpenLayers.Feature.Vector.style["default"]["strokeWidth"] = 3; // Default too thin for linestrings. ***REMOVED***% endif %***REMOVED***
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector = new OpenLayers.Layer.Vector(" ***REMOVED******REMOVED*** field_name ***REMOVED******REMOVED***");
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addLayer(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector);
    // Read WKT from the text field.
    var wkt = document.getElementById('***REMOVED******REMOVED*** id ***REMOVED******REMOVED***').value;
    if (wkt)***REMOVED***
        // After reading into geometry, immediately write back to
        // WKT <textarea> as EWKT (so that SRID is included).
        var admin_geom = ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.read_wkt(wkt);
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.write_wkt(admin_geom);
        if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_collection)***REMOVED***
            // If geometry collection, add each component individually so they may be
            // edited individually.
            for (var i = 0; i < ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.num_geom; i++)***REMOVED***
                ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.addFeatures([new OpenLayers.Feature.Vector(admin_geom.geometry.components[i].clone())]);
            ***REMOVED***
        ***REMOVED*** else ***REMOVED***
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.addFeatures([admin_geom]);
        ***REMOVED***
        // Zooming to the bounds.
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.zoomToExtent(admin_geom.geometry.getBounds());
        if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.is_point)***REMOVED***
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.zoomTo(***REMOVED******REMOVED*** point_zoom ***REMOVED******REMOVED***);
        ***REMOVED***
    ***REMOVED*** else ***REMOVED***
        ***REMOVED***% localize off %***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.setCenter(new OpenLayers.LonLat(***REMOVED******REMOVED*** default_lon ***REMOVED******REMOVED***, ***REMOVED******REMOVED*** default_lat ***REMOVED******REMOVED***), ***REMOVED******REMOVED*** default_zoom ***REMOVED******REMOVED***);
        ***REMOVED***% endlocalize %***REMOVED***
    ***REMOVED***
    // This allows editing of the geographic fields -- the modified WKT is
    // written back to the content field (as EWKT, so that the ORM will know
    // to transform back to original SRID).
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.events.on(***REMOVED***"featuremodified" : ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modify_wkt***REMOVED***);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector.events.on(***REMOVED***"featureadded" : ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.add_wkt***REMOVED***);
    ***REMOVED***% block controls %***REMOVED***
    // Map controls:
    // Add geometry specific panel of toolbar controls
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.getControls(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.layers.vector);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.panel.addControls(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.controls);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addControl(***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.panel);
    ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.addSelectControl();
    // Then add optional visual controls
    ***REMOVED***% if mouse_position %***REMOVED******REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addControl(new OpenLayers.Control.MousePosition());***REMOVED***% endif %***REMOVED***
    ***REMOVED***% if scale_text %***REMOVED******REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addControl(new OpenLayers.Control.Scale());***REMOVED***% endif %***REMOVED***
    ***REMOVED***% if layerswitcher %***REMOVED******REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.addControl(new OpenLayers.Control.LayerSwitcher());***REMOVED***% endif %***REMOVED***
    // Then add optional behavior controls
    ***REMOVED***% if not scrollable %***REMOVED******REMOVED******REMOVED*** module ***REMOVED******REMOVED***.map.getControlsByClass('OpenLayers.Control.Navigation')[0].disableZoomWheel();***REMOVED***% endif %***REMOVED***
    ***REMOVED***% endblock %***REMOVED***
    if (wkt)***REMOVED***
        if (***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.modifiable)***REMOVED***
            ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.enableEditing();
        ***REMOVED***
    ***REMOVED*** else ***REMOVED***
        ***REMOVED******REMOVED*** module ***REMOVED******REMOVED***.enableDrawing();
    ***REMOVED***
***REMOVED***;
